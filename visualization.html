<!DOCTYPE html>
<html lang="en">

<body style="background-color:#000000">
    <canvas id="myCanvas" width="500" height="500" style="border:1px solid aliceblue"></canvas>
    <div style="color:aliceblue">
        <input type="radio" id="electron" name="object" value="electron">
        <label for="electron">electron</label>
        <input type="radio" id="proton" name="object" value="proton">
        <label for="proton">proton</label>
        <input type="radio" id="sensor" name="object" value="sensor">
        <label for="sensor">sensor</label>
    </div>
    <div style="color:aliceblue">
        <label for="fluxScale">fluxScale</label>
        <input type="range" min="50000" max="2000000" value="500000" id="fluxScale" onchange="setScale()">
    </div>
</body>


<script>
    var fluxScale = document.getElementById("fluxScale").value;
    var startTime, endTime;
    var c = document.getElementById("myCanvas");

    const electronImage = new Image();
    const electronCanvas = new OffscreenCanvas(50, 50);
    electronImage.onload = function () { electronCanvas.getContext('2d').drawImage(electronImage, 0, 0, 50, 50); };
    electronImage.src = "electron.png";

    const protonImage = new Image();
    const protonCanvas = new OffscreenCanvas(50, 50);
    protonImage.onload = function () { protonCanvas.getContext('2d').drawImage(protonImage, 0, 0, 50, 50); };
    protonImage.src = "proton.png";

    const sensorScale = 100000;

    var electrons = [];
    var protons = [];
    var sensors = [];

    const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

    const scale = (number, [inMin, inMax], [outMin, outMax]) => {
        // if you need an integer value use Math.floor or Math.ceil here
        return (number - inMin) / (inMax - inMin) * (outMax - outMin) + outMin;
    }

    function drawSubatoms(ctx) {
        electrons.forEach(electron => {
            //console.log(electrons[electron]);
            ctx.drawImage(electronCanvas, electron[0] - 25, electron[1] - 25);
        });
        protons.forEach(proton => {
            //console.log(protons[proton]);
            ctx.drawImage(protonCanvas, proton[0] - 25, proton[1] - 25);
        });
    }

    function drawSensors(ctx) {
        sensors.forEach(sensor => {
            ctx.beginPath();
            ctx.arc(sensor[0], sensor[1], 8, 0, 2 * Math.PI);
            ctx.fillStyle = "#eda655";
            ctx.fill();

            var fieldVec = [0, 0];

            protons.forEach(proton => {
                const distx = sensor[0] - proton[0];
                const disty = sensor[1] - proton[1];
                const dist = Math.sqrt(distx * distx + disty * disty);
                const strength = 1 / (dist * dist);

                fieldVec[0] += strength * (distx / dist);
                fieldVec[1] += strength * (disty / dist);
            });

            electrons.forEach(electron => {
                const distx = sensor[0] - electron[0];
                const disty = sensor[1] - electron[1];
                const dist = Math.sqrt(distx * distx + disty * disty);
                const strength = 1 / (dist * dist);

                fieldVec[0] -= strength * (distx / dist);
                fieldVec[1] -= strength * (disty / dist);
            });


            fieldVec[0] *= sensorScale;
            fieldVec[1] *= sensorScale;
            ctx.beginPath();
            ctx.moveTo(sensor[0], sensor[1]);
            ctx.lineTo(sensor[0] + (fieldVec[0] | 0), sensor[1] + (fieldVec[1]) | 0);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 5;
            ctx.stroke();
        })
    }

    function drawFlux() {
        if (!c.getContext) {
            alert("html5 is not supported in this web browser!");
            return;
        }
        var ctx = c.getContext("2d");

        let pixels = new ImageData(500, 500);
        for (var y = 0; y < 500; y++) {
            for (var x = 0; x < 500; x++) {
                var fieldVec = [0, 0];

                protons.forEach(proton => {
                    const distx = x - proton[0];
                    const disty = y - proton[1];
                    const dist = Math.sqrt(distx * distx + disty * disty);
                    const strength = 1 / (dist * dist);

                    fieldVec[0] += strength * (distx / dist);
                    fieldVec[1] += strength * (disty / dist);
                });

                electrons.forEach(electron => {
                    const distx = x - electron[0];
                    const disty = y - electron[1];
                    const dist = Math.sqrt(distx * distx + disty * disty);
                    const strength = 1 / (dist * dist);

                    fieldVec[0] -= strength * (distx / dist);
                    fieldVec[1] -= strength * (disty / dist);
                });

                const finalDirection = Math.atan2(fieldVec[1], fieldVec[0]);
                const finalStrength = Math.sqrt(fieldVec[0] * fieldVec[0] + fieldVec[1] * fieldVec[1]);

                const ptr = (x + y * 500) * 4;
                pixels.data[ptr] = scale(fieldVec[0] / finalStrength, [-1, 1], [0, 255]); //r
                pixels.data[ptr + 1] = scale(fieldVec[1] / finalStrength, [-1, 1], [0, 255]); //g
                pixels.data[ptr + 2] = 255; //b
                pixels.data[ptr + 3] = finalStrength * fluxScale; //a

            }
        }

        ctx.putImageData(pixels, 0, 0);

        drawSubatoms(ctx);
        drawSensors(ctx);
    }

    drawFlux();


    c.addEventListener("click", function (e) {



        //get which object is currently selected to place
        var options = document.getElementsByName('object');
        var selected;
        for (var i = 0; i < options.length; i++) {
            if (options[i].checked) {
                selected = options[i].value;
            }
        }

        var x = e.pageX - c.offsetLeft;
        var y = e.pageY - c.offsetTop;
        if (selected == "electron") {

            electrons[electrons.length] = [x, y];
            drawFlux();
        }
        else if (selected == "proton") {

            protons[protons.length] = [x, y];
            drawFlux();
        }
        else if (selected == "sensor") {

            sensors[sensors.length] = [x, y];
            drawFlux();
        }

    });


    function setScale() {
        fluxScale = document.getElementById("fluxScale").value;
        drawFlux();
    }

</script>

</html>