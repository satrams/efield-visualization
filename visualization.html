<!DOCTYPE html>
<html lang="en">

<body style="background-color:#000000">
    <canvas id="myCanvas" width="500" height="500" style="border:1px solid aliceblue"></canvas>
    <div style="color:aliceblue">
        <input type="radio" id="electron" name="object" value="electron">
        <label for="electron">electron</label>
        <input type="radio" id="proton" name="object" value="proton">
        <label for="proton">proton</label>
        <input type="radio" id="sensor" name="object" value="sensor">
        <label for="sensor">sensor</label>
    </div>
    <div style="color:aliceblue">
        <label for="fluxScale">fluxScale</label>
        <input type="range" min="50000" max="2000000" value="500000" id="fluxScale">
        <button onclick="setScale()">submit</button>
    </div>
</body>


<script>
    var fluxScale = document.getElementById("fluxScale").value;
    var startTime, endTime;
    var c = document.getElementById("myCanvas");

    const electronImage = new Image();
    const electronCanvas = new OffscreenCanvas(50, 50);
    electronImage.onload = function () { electronCanvas.getContext('2d').drawImage(electronImage, 0, 0, 50, 50); };
    electronImage.src = "electron.png";

    const protonImage = new Image();
    const protonCanvas = new OffscreenCanvas(50, 50);
    protonImage.onload = function () { protonCanvas.getContext('2d').drawImage(protonImage, 0, 0, 50, 50); };
    protonImage.src = "proton.png";

    var electrons = [];
    var protons = [];

    const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

    const scale = (number, [inMin, inMax], [outMin, outMax]) => {
        // if you need an integer value use Math.floor or Math.ceil here
        return (number - inMin) / (inMax - inMin) * (outMax - outMin) + outMin;
    }

    function drawSubatoms(ctx) {
        for (var electron in electrons) {
            //console.log(electrons[electron]);
            ctx.drawImage(electronCanvas, electrons[electron][0] - 25, electrons[electron][1] - 25);
        }
        for (var proton in protons) {
            //console.log(protons[proton]);
            ctx.drawImage(protonCanvas, protons[proton][0] - 25, protons[proton][1] - 25);
        }
    }

    function drawFlux() {
        if (!c.getContext) {
            alert("html5 is not supported in this web browser!");
            return;
        }
        var ctx = c.getContext("2d");

        let pixels = new ImageData(500, 500);
        for (var y = 0; y < 500; y++) {
            for (var x = 0; x < 500; x++) {
                var fieldVec = [0, 0];

                protons.forEach(proton => {
                    const distx = x - proton[0];
                    const disty = y - proton[1];
                    const dist = Math.sqrt(distx * distx + disty * disty);
                    const strength = 1 / (dist * dist);

                    fieldVec[0] += strength * (distx / dist);
                    fieldVec[1] += strength * (disty / dist);
                });

                electrons.forEach(electron => {
                    const distx = x - electron[0];
                    const disty = y - electron[1];
                    const dist = Math.sqrt(distx * distx + disty * disty);
                    const strength = 1 / (dist * dist);

                    fieldVec[0] -= strength * (distx / dist);
                    fieldVec[1] -= strength * (disty / dist);
                });

                const finalDirection = Math.atan2(fieldVec[1], fieldVec[0]);
                const finalStrength = Math.sqrt(fieldVec[0] * fieldVec[0] + fieldVec[1] * fieldVec[1]);

                const ptr = (x + y * 500) * 4;
                pixels.data[ptr] = scale(fieldVec[0] / finalStrength, [-1, 1], [0, 255]); //r
                pixels.data[ptr + 1] = scale(fieldVec[1] / finalStrength, [-1, 1], [0, 255]); //g
                pixels.data[ptr + 2] = 255; //b
                pixels.data[ptr + 3] = finalStrength * fluxScale; //a

            }
        }

        ctx.putImageData(pixels, 0, 0);

        drawSubatoms(ctx);
    }

    drawFlux();


    c.addEventListener("click", function (e) {



        //get which object is currently selected to place
        var options = document.getElementsByName('object');
        var selected;
        for (var i = 0; i < options.length; i++) {
            if (options[i].checked) {
                selected = options[i].value;
            }
        }

        if (selected == "electron") {
            var x = e.pageX - c.offsetLeft;
            var y = e.pageY - c.offsetTop;

            electrons[electrons.length] = [x, y];
            drawFlux();
        }
        else if (selected == "proton") {
            var x = e.pageX - c.offsetLeft;
            var y = e.pageY - c.offsetTop;

            protons[protons.length] = [x, y];
            drawFlux();
        }

    });


    function setScale() {
        fluxScale = document.getElementById("fluxScale").value;
        drawFlux();
    }

</script>

</html>